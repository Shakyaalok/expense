<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer"
    />
    <title>Add Expense </title>
</head>
<script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.16.1/axios.min.js'></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="	https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<body>


    <nav class="navbar navbar-expand-lg fixed-top" style="background-color:  #610C9F;">
        <div class="container-fluid">
            <a class="navbar-brand text-white fw-bold fs-5" href="/index.html">ExpenseApp</a>
            <button class="navbar-toggler border-0 shadow-none " type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDarkNavbar" aria-controls="offcanvasDarkNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasDarkNavbar" aria-labelledby="offcanvasDarkNavbarLabel">
                <div class="offcanvas-header" style="border-bottom: 1px solid #940B92;">
                    <h5 class="offcanvas-title" id="offcanvasDarkNavbarLabel">ExpenseApp</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3 d-flex align-items-center gap-2 m-2">
                        <li class="nav-item">
                            <a class="nav-link  text-white p-2 rounded" aria-current="page" href="/index.html">Home</a>
                        </li>
                        <!-- <li class="nav-item">
                            <a class="nav-link text-white  p-2 rounded" href="/about.html">About</a>
                        </li> -->

                        <li class="nav-item">
                            <a class="nav-link text-white  p-2 rounded" href="/contact.html">Contact</a>
                        </li>



                        <li class="nav-item" id="premiumParent-1">
                            <div class="nav-link rounded p-2 fw-bold text-white" style="background-color:#940B92; " id="buypremium">Buy Premium</div>

                        </li>
                        <li class="nav-item" id="premiumParent-2" class="cursor"></li>
                        <li class="nav-item" id="premiumParent-4" class="cursor"></li>
                        <li class="nav-item" id="premiumParent-3" class="cursor"></li>

                        <li id="logout_li" class="cursor">

                        </li>
                    </ul>


                </div>
            </div>
        </div>
    </nav>
    <div>
        <h1>d</h1>
    </div>




    <div class="container sectionform">
        <div class="row form" style="margin-top: 60px;">
            <h2 class="text-center mb-4">Add your expense</h2>
            <h3 id="MsgTop"></h3>
            <form>

                <div class="form-group">
                    <label for="product-name">Product Name</label>
                    <input type="text" name="product-name" class="form-control" id="product-name" placeholder=" " required>

                </div>

                <div class="form-group">
                    <label for="product-price">Product Price</label>
                    <input type="number" name="product-price" class="form-control" id="product-price" placeholder=" " required>

                </div>



                <div class="dropdown">
                    <label for="product-category">Product Category</label>
                    <select class="btn-default dropdown-set" name="product-category" id="product-category">
                        <option value="" style="font-size: 1rem;">Choose the category</option>
                        <option value="Skin Care">Skin Care</option>
                        <option value="Foods">Foods</option>
                        <option value="Electric">Electric</option>
                        <option value="Petrol">Petrol</option>
                        <option value="others">others</option>

                    </select>
                </div>




                <div class="form-group">
                    <label for="remarks">Remaks</label>
                    <input type="text" name="remarks" class="form-control" id="remarks" placeholder="optional" required>

                </div>





                <button type="button" class="btn btn-success" id="btn-add-expense">Add Expense</button>


            </form>
        </div>

    </div>

    <div class="container sectionExpense">
        <h3 class="text-center mb-3">Your expense</h3>
        <input type="hidden" id="currentPageValue"><input type="hidden" id="totalPageValue">
        <div class="row" id="showExpense">
        </div>
    </div>



    <div class="container">
        <div id="expense-list" class="mt-4"></div>
        <nav aria-label="..." class="d-flex justify-content-end mt-4">
            <ul class="pagination" id="pagination">
                <li class="page-item " id="prev-page">
                    <div class="page-link pageBtn" id="fetchPrevId">Previous</div>
                </li>

                <li id="numPage"></li>
                <li class="page-item" id="next-page">
                    <div class="page-link pageBtn" id="fetchNextId">Next</div>
                </li>
                <li class="page-item" id="search-page">
                    <input type="number" class="page-link pageTypeNum" pattern="[0-9]*" title="Please enter a non-negative number." onchange="typePage(event)" id="searchPageOnType">
                </li>
            </ul>
        </nav>
    </div>

    <!-- showing the content on button click or dom loaded -->
    <div class="container" id="toptopleaderBoardHeading"></div>
    <div class="container" id="showreportondom">

    </div>






    <!-- footer -->
    <div class="footer">
        <div class="row" id="footer">

            <div class="col-md-8">

                <h4>Plot: 35 </h4>
                <h4>Area: Chappraula Gautam Buddha Nagar</h4>
                <h4>Pincode: 201009 </h4>
                <h4>State/District: Gautam Buddha Nagar</h4>

            </div>
            <div class="col-md-4" id="right-footer">
                <h4>ph No: 888XXX888X</h4>
            </div>
        </div>

        <!-- sub-footer -->
        <div id="sub-footer">
            <div class="row">
                <div class="col-md-12" style="margin-top: 6px;">
                    <p>2023@ copyright reserved</p>
                </div>
            </div>
        </div>

    </div>





    <script>
        const expenseBtn = document.getElementById('btn-add-expense');
        const show = document.getElementById('show'); // show all previous expense on button
        const buypremiumBtn = document.getElementById('buypremium').addEventListener('click', buyPremium)

        expenseBtn.addEventListener('click', addExpense);
        async function addExpense() {
            const productName = document.getElementById('product-name').value
            const productPrice = document.getElementById('product-price').value
            const productCategory = document.getElementById('product-category').value
            const remarks = document.getElementById('remarks').value


            const expenseDetails = {
                productName: productName,
                productPrice: productPrice,
                productCategory: productCategory,
                remarks: remarks
            }

            // getting the token
            const token = localStorage.getItem('token');
            await axios.post('http://localhost:4000/expense/add', expenseDetails, {
                    headers: {
                        'Authorization': token
                    }
                })
                .then((response) => {
                    // console.log(response.data);
                    // console.log(response, response.headers.date)
                    // showExpense(response.data.expense)
                    showMsgOnTop(response.data.message)
                })
                .catch((err) => console.log('error in expense.js file', err))

            //resetting the input value
            document.getElementById('product-name').value = ""
            document.getElementById('product-price').value = ""
            document.getElementById('product-category').value = ""
            document.getElementById('remarks').value = ""
        }

        // logout
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (token) {
                const logoutButtonLi = document.getElementById('logout_li');
                logoutButtonLi.innerHTML = `<a class="nav-link  p-2 rounded text-white pointer" id="logoutAnchor" onclick="logout()">Logout</a>`;
            } else {
                showMsgOnTop('something went wrong')
            }
        })


        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }




        // pagination
        window.addEventListener('DOMContentLoaded', fetchPage);

        async function fetchPage(page) {
            if (typeof page == "object") {
                page = 1;
            }
            const token = localStorage.getItem('token');
            const decodeToken = parseJwt(token);
            const userId = decodeToken.userId;

            // console.log(userId)
            const response = await axios.get(`http://localhost:4000/pagination/${userId}?page=${page}`, {
                headers: {
                    'Authorization': token
                }
            })
            showExpensePages(response.data.Expenses)
            document.getElementById("currentPageValue").value = page || 1;
            document.getElementById("totalPageValue").value = response.data.totalPages;

        }

        const prevButton = document.getElementById('fetchPrevId')
        const nextButton = document.getElementById('fetchNextId')
        document.getElementById('fetchPrevId').addEventListener('click', fetchPrev);
        document.getElementById('fetchNextId').addEventListener('click', fetchNext);

        async function fetchPrev(event) {
            const currentPage = parseInt(document.getElementById("currentPageValue").value || 1);
            const totalPageValue = parseInt(document.getElementById("totalPageValue").value);
            event.preventDefault()
            nextButton.classList.remove('disabled')
            if (currentPage - 1 == 0) {
                prevButton.classList.add('disabled')
            } else {
                prevButton.classList.remove('disabled');
                await fetchPage(currentPage - 1);
            }
        }

        async function fetchNext(event) {
            event.preventDefault()
            const currentPage = parseInt(document.getElementById("currentPageValue").value || 1);
            const totalPageValue = parseInt(document.getElementById("totalPageValue").value);
            prevButton.classList.remove('disabled');
            if (currentPage + 1 == totalPageValue) {
                nextButton.classList.add('disabled')
            }
            await fetchPage(currentPage + 1);
        }

        // pagination on type
        async function typePage(e) {

            e.preventDefault();
            const SearchType = document.getElementById('searchPageOnType').value;
            const num = parseInt(SearchType)

            if (SearchType <= 0) {
                return showMsgOnTop('Enter positive number')
            }

            const isPageAvailable = await fetchPage(num);
            if (isPageAvailable == undefined) {
                return showMsgOnTop('Nothing to show')
            } else {
                isPageAvailable
            }

            document.getElementById('searchPageOnType').value = '';
        }

        // get all expenses when the dom is loaded
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token')
                // console.log('tokn=en for the premium user', token)

            const decodeToken = parseJwt(token);
            // console.log(decodeToken)
            // console.log(decodeToken.ispremiumuser)
            if (decodeToken.ispremiumuser) {
                // premium--2
                document.getElementById('buypremium').classList.add('cursor')
                document.getElementById('buypremium').style.display = 'none';
                document.getElementById('premiumParent-1').innerHTML = '<h4>Premium</h4>';
                //show leaderBoard-section after purchasing
                document.getElementById('premiumParent-2').innerHTML = `<div class="nav-link rounded p-2 fw-bold text-white cursor" style="background-color:#940B92;" onclick="showleaderBoard()"  id="leaderBoard">LeaderBoard</div>`
                document.getElementById('toptopleaderBoardHeading').innerHTML = `<h3 class="text-center mb-3 cursor" id="headingofleaderboard">LeaderBoard</h3>
        <div class="row" id="showLeaderBoard"></div>`
                document.getElementById('premiumParent-3').innerHTML = `<div class="nav-link rounded cursor" onclick="downloadReport()" id="downloadreport"><i class="fa-solid fa-download"></i></div>`
                document.getElementById('premiumParent-4').innerHTML = `<button   type="button" class="rounded btn btn-success fw-bold text-white border-0"  style="background-color:#940B92;" onclick="showdownloadReport()" id="showreport">Previous Download</button>`
                document.getElementById('showreportondom').innerHTML = `<h3 class="text-center">Previous Dowloaded History</h3>
                            <div id="showheading"></div>
                            `


            }



            // this is commented out due to pagination api because it show all the expense at once when dom is loaded
            // axios.get('http://localhost:4000/expense/', {
            //         headers: {
            //             'Authorization': token
            //         }
            //     })
            //     .then((response) => {
            //         for (const item of response.data.expenses) {
            //             // showExpense(item)

            //         }
            //     })

        })

        // download report
        function downloadReport() {
            const token = localStorage.getItem('token');
            axios.get('http://localhost:4000/download', {
                    headers: {
                        'Authorization': token
                    }
                })
                .then((response) => {
                    // console.log(response.data.fileURL)
                    if (response.status === 201) {
                        DowloadFile(response.data.fileURL)
                    }

                })
                .catch((err) => {

                    console.log('error from frontend of download Report', err)
                })
        }

        // show report

        function showdownloadReport() {
            const token = localStorage.getItem('token');
            const decodeToken = parseJwt(token)
            const userId = decodeToken.userId
                // console.log(userId)

            axios.get(`http://localhost:4000/download/report/${userId}`, {
                    headers: {
                        'Authorization': token
                    }
                })
                .then((response) => {

                    // console.log(response.data)
                    for (const data of response.data.fileDownloadHistory) {
                        showReport(data)
                            // console.log(data.id)
                    }
                })
                .catch((err) => {
                    console.log('something went wrong from fronted of showing the previous data', err)
                })
        }

        function showReport(details) {
            const showReportDOM = document.getElementById('showheading');
            const newDiv = document.createElement('div')
            newDiv.innerHTML = `

            <div class="card d-flex justify-content-between flex-row p-4 mb-4 mt-4 text-white"  style="background-color:#940B92; "> 
                <div style="font-size: 1rem;  font-weight: 500; overflow: hidden;" >${details.fileUrl}</div>
                <div style="font-weight: 700;"><i class="fa-solid fa-download" style="font-size:2rem" onclick="DowloadFile('${details.fileUrl}')"></i></div>
                </div>            
            `
            showReportDOM.appendChild(newDiv)

        }


        //function to download the file
        function DowloadFile(fileUrl) {
            var a = document.createElement('a');
            a.href = fileUrl; // when doing in the reposne then response.data.fileURL
            a.download = 'myexpense.csv';
            a.click(); // this line is very important to start the dowloading
        }

        // get one expense 
        function getOneExpense(ID) {
            axios.get(`http://localhost:4000/expense/${ID}`)
                .then((response) => {
                    showExpense(response.data.expense)
                })
        }


        // delete Expense
        function deletee(ID) {
            const token = localStorage.getItem('token');
            axios.delete(`http://localhost:4000/expense/delete/${ID}`, {
                    headers: {
                        'Authorization': token
                    }
                })
                .then((response) => {
                    refreshAfterDelete(ID)
                })
        }

        // refresh after delete
        function refreshAfterDelete(ID) {
            document.getElementById('target_' + ID).remove();
        }

        // buyPremium
        async function buyPremium() {
            const token = localStorage.getItem('token');

            try {
                const response = await axios.get('http://localhost:4000/premium/payment', {
                    headers: {
                        'Authorization': token
                    }
                });


                const options = {
                    "key": response.data.key_id,
                    "order_id": response.data.order.id,
                    "handler": async function(response) {
                        try {
                            const paymentResponse = await axios.post('http://localhost:4000/premium/updatetransactions', {
                                order_id: options.order_id,
                                payment_id: response.razorpay_payment_id,
                            }, {
                                headers: {
                                    'Authorization': token
                                }
                            });

                            alert('Congratulations on becoming a valuable customer');
                            // premium--1
                            document.getElementById('buypremium').classList.add('cursor')
                            document.getElementById('buypremium').style.display = 'none';
                            document.getElementById('premiumParent-1').innerHTML = '<h4>Premium</h4>';
                            document.getElementById('premiumParent-3').innerHTML = `<div class="nav-link rounded cursor" onclick="downloadReport()" id="downloadreport"><i class="fa-solid fa-download"></i></div>`;
                            document.getElementById('premiumParent-4').innerHTML = `<button   type="button" class="rounded btn btn-success fw-bold text-white border-0"  style="background-color:#940B92;" onclick="showReport()" id="showreport">Previous Download</button>`
                            document.getElementById('showreportondom').innerHTML = `<h3 class="text-center">Previous Dowloaded History</h3>
                            <div id="showheading"></div>
                            `


                            // setting the updated token
                            // console.log('token for updation', paymentResponse.data.token)
                            localStorage.setItem('token', paymentResponse.data.token)

                        } catch (error) {
                            console.error('Error updating transaction:', error);
                            alert('Something went wrong');
                        }
                    }
                };

                const rzpl = new Razorpay(options);
                rzpl.open();

                rzpl.on('payment.failed', function(response) {
                    // console.error('Payment failed:', response);
                    alert('Something went wrong');
                });
            } catch (error) {
                console.error('Error fetching payment details:', error);
                alert('Something went wrong');
            }
        }


        // show leaderBoard
        function showleaderBoard() {
            const token = localStorage.getItem('token')

            axios.get('http://localhost:4000/leaderboad', {
                    headers: {
                        'Authorization': token
                    }
                })
                .then((response) => {
                    // console.log(response)
                    let count = 0;
                    for (const item of response.data) {

                        printLeaderBoardOnDom(item, count++)
                    }



                })
        }

        function printLeaderBoardOnDom(DETAILS, rank) {

            const heading = document.getElementById('showLeaderBoard');
            const Div = document.createElement('div');
            Div.classList.add('col-lg-4', 'col-md-6', 'col-sm-12', 'mb-4')
            Div.innerHTML = `

            
            <div class="card d-flex flex-wrap gap-1 p-2 text-white shadow" style="width: 18rem;  background: #3b1557;" >
                <div class="text-success" style="font-size:20px;">Rank: ${rank+1} </div>   
                        <div> Name: ${DETAILS.name} </div>
                        <div>Total Expense: ${DETAILS.totalExpenses} </div>            
                                
                        <div>
                </div>
            </div>
        `;
            heading.appendChild(Div)
        }

        // show premium after purchasing
        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }


        // show message on top
        function showMsgOnTop(Details) {
            const ExistingEmptyElement = document.getElementById('MsgTop');
            ExistingEmptyElement.innerHTML = ''
            const Div = document.createElement('div');
            Div.innerHTML = `
           <span> ${Details} </span>
           `;

            ExistingEmptyElement.appendChild(Div)


        }


        function showExpensePages(detailsDt) {
            // console.log(detailsDt)
            const ExistingElement = document.getElementById('showExpense');
            ExistingElement.innerHTML = '';
            for (const details of detailsDt) {
                const Div = document.createElement('div');
                Div.innerHTML = ` 
            <div class="card flex-wrap p-2 text-success shadow cardStyle" style="background: #3b1557;" id="target_${details.id}">
                <span> Product Name: <span  class="cardStyle-color">${details.productName}</span> </span>
                <span> Product Price: <span  class="cardStyle-color">${details.productPrice}</span> </span>
                <span> Product Category: <span  class="cardStyle-color">${details.productCategory}</span> </span>
                <span> Remarks: <span  class="cardStyle-color">${details.remarks}</span> </span>
                <div>
                    <div class="position-absolute top-0 end-0 text bg-danger p-2 text-white rounded m-0" type="button" onclick="deletee('${details.id}')">X</div>
                </div>
            </div>
        `;
                ExistingElement.appendChild(Div);
            }

        }




        function showExpense(details) {
            const ExistingElement = document.getElementById('showExpense');
            ExistingElement.innerHTML = '';
            const Div = document.createElement('div');
            Div.innerHTML = ` 
            <div class="card flex-wrap gap-4 p-2 text-success shadow cardStyle" style="background: #3b1557;" id="target_${details.id}">
                <span> Product Name: <span  class="cardStyle-color">${details.productName}</span> </span>
                <span> Product Price: <span  class="cardStyle-color">${details.productPrice}</span> </span>
                <span> Product Category: <span  class="cardStyle-color">${details.productCategory}</span> </span>
                <span> Remarks: <span  class="cardStyle-color">${details.remarks}</span> </span>
                <div>
                    <div class="position-absolute top-0 end-0 text bg-danger p-2 text-white rounded m-0" type="button" onclick="deletee('${details.id}')">X</div>
                </div>
            </div>
        `;
            ExistingElement.appendChild(Div);

        }
    </script>
</body>

</html>